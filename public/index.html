<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0c">
<title>WinRM Bridge // Hive</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;600;800&display=swap');
  :root {
    --bg:#0a0a0c;--surface:#111114;--surface2:#18181c;--border:#2a2a30;
    --text:#c8c8d0;--text-dim:#66666e;--accent:#f59e0b;--accent-dim:#78500d;
    --green:#22c55e;--red:#ef4444;--blue:#3b82f6;
    --mono:'JetBrains Mono',monospace;--sans:'Outfit',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;overflow:hidden;touch-action:manipulation}
  body{font-family:var(--mono);background:var(--bg);color:var(--text);display:flex;flex-direction:column}

  /* HEADER */
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;min-height:48px}
  .header-left{display:flex;align-items:center;gap:10px}
  .btn-menu{background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:4px 8px;line-height:1}
  .logo{font-family:var(--sans);font-weight:800;font-size:15px;color:var(--accent);letter-spacing:-0.5px}
  .logo span{color:var(--text-dim);font-weight:300}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .header-right{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-dim)}
  .session-count{color:var(--accent);font-weight:500}

  /* QUICK CONNECT BAR (mobile) */
  .quick-bar{display:block;flex-shrink:0;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .quick-bar::-webkit-scrollbar{display:none}
  .quick-bar .qb{display:inline-block;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 14px;font-family:var(--mono);font-size:13px;cursor:pointer;border-radius:6px;margin-right:6px;transition:all .15s;-webkit-user-select:none;user-select:none}
  .quick-bar .qb:active{background:var(--accent);color:#000;border-color:var(--accent)}

  /* DRAWER OVERLAY */
  .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:50}
  .drawer-overlay.show{display:block}

  /* SIDEBAR / DRAWER */
  .sidebar{position:fixed;top:0;left:-300px;width:300px;height:100%;z-index:60;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);transition:left .25s ease;overflow:hidden}
  .sidebar.open{left:0}
  .sidebar-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;min-height:52px}
  .sidebar-title{font-size:12px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim)}
  .btn-new{background:var(--accent);color:#000;border:none;padding:8px 14px;font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer;border-radius:4px}
  .btn-new:active{background:#fbbf24}
  .sessions-list{flex:1;overflow-y:auto;padding:8px;-webkit-overflow-scrolling:touch}
  .session-card{padding:14px;border:1px solid transparent;border-radius:6px;cursor:pointer;margin-bottom:6px;transition:all .15s;min-height:48px}
  .session-card:active{background:var(--surface2);border-color:var(--border)}
  .session-card.active{background:var(--surface2);border-color:var(--accent-dim)}
  .session-label{font-size:14px;font-weight:500;color:var(--text)}
  .session-meta{font-size:12px;color:var(--text-dim);margin-top:4px;display:flex;gap:12px}
  .session-meta .computer{color:var(--blue)}
  .session-meta .cmds{color:var(--accent)}
  .no-sessions{padding:30px 16px;text-align:center;color:var(--text-dim);font-size:13px;line-height:1.6}
  .quick-connect{padding:14px 16px;border-top:1px solid var(--border)}
  .quick-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:8px}
  .quick-btns{display:flex;flex-wrap:wrap;gap:6px}
  .quick-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 14px;font-family:var(--mono);font-size:13px;cursor:pointer;border-radius:6px;transition:all .15s}
  .quick-btn:active{border-color:var(--accent);color:var(--accent)}

  /* SESSION TABS */
  .session-tabs{display:flex;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;min-height:0}
  .session-tabs::-webkit-scrollbar{display:none}
  .session-tabs:empty{display:none}
  .stab{display:flex;align-items:center;gap:6px;padding:10px 14px;font-family:var(--mono);font-size:12px;color:var(--text-dim);cursor:pointer;border-right:1px solid var(--border);white-space:nowrap;transition:all .15s;min-height:40px;-webkit-user-select:none;user-select:none}
  .stab:active,.stab:hover{background:var(--surface2);color:var(--text)}
  .stab.active{color:var(--accent);background:var(--bg);border-bottom:2px solid var(--accent)}
  .stab .sdot{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0}
  .stab .sclose{color:var(--text-dim);font-size:14px;margin-left:4px;padding:2px 4px;border-radius:3px;line-height:1}
  .stab .sclose:hover,.stab .sclose:active{color:var(--red);background:var(--surface2)}

  /* TERMINAL AREA */
  .terminal-area{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;min-height:0;overflow:hidden}
  .terminal-header{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);min-height:44px;flex-shrink:0;gap:8px}
  .terminal-title{font-size:12px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
  .terminal-title .name{color:var(--accent);font-weight:500}
  .terminal-actions{display:flex;gap:6px;flex-shrink:0}
  .btn-action{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px 12px;font-family:var(--mono);font-size:12px;cursor:pointer;border-radius:4px;white-space:nowrap}
  .btn-action:active{border-color:var(--text-dim);color:var(--text)}
  .btn-action.danger:active{border-color:var(--red);color:var(--red)}
  .btn-action.broadcast{color:var(--accent);border-color:var(--accent-dim)}
  .btn-action.broadcast:active{background:var(--accent);color:#000}
  .btn-action.stop{background:var(--red);color:#fff;border-color:var(--red);animation:pulse-red 1s infinite}
  @keyframes pulse-red{0%,100%{opacity:1}50%{opacity:.7}}
  .session-running{color:var(--accent);font-size:11px;animation:pulse 1s infinite}

  /* OUTPUT */
  .terminal-output{flex:1;overflow-y:auto;padding:14px 16px;font-size:13px;line-height:1.65;-webkit-overflow-scrolling:touch;min-height:0}
  .output-entry{margin-bottom:14px;overflow-wrap:break-word;word-break:break-word}
  .output-cmd{color:var(--accent);font-weight:500}
  .output-cmd::before{content:'❯ ';color:var(--text-dim)}
  .output-result{color:var(--text);white-space:pre-wrap;overflow-wrap:break-word;margin-top:4px;padding-left:2px;font-size:12px}
  .output-error{color:var(--red)}
  .output-info{color:var(--text-dim);font-style:italic}
  .output-time{color:var(--text-dim);font-size:11px;float:right}
  .welcome-msg{color:var(--text-dim);padding:40px 16px;text-align:center;font-size:13px;line-height:2}
  .welcome-msg .big{font-family:var(--sans);font-size:22px;font-weight:600;color:var(--text)}

  /* INPUT */
  .terminal-input-area{padding:10px 12px;border-top:1px solid var(--border);background:var(--surface);display:flex;align-items:center;gap:8px;flex-shrink:0}
  .prompt{color:var(--accent);font-weight:700;font-size:14px}
  .terminal-input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:14px;outline:none;caret-color:var(--accent);padding:10px 12px;border-radius:6px;min-width:0}
  .terminal-input:focus{border-color:var(--accent)}
  .terminal-input::placeholder{color:var(--text-dim)}
  .terminal-input:disabled{opacity:.4}
  .btn-send{background:var(--accent);color:#000;border:none;padding:10px 16px;font-family:var(--mono);font-size:14px;font-weight:700;cursor:pointer;border-radius:6px;flex-shrink:0;min-width:48px;min-height:44px}
  .btn-send:active{background:#fbbf24}
  .btn-send:disabled{opacity:.3}

  /* MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:flex-end;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:12px 12px 0 0;padding:24px 20px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
  .modal h3{font-family:var(--sans);font-weight:600;font-size:18px;margin-bottom:18px;color:var(--accent)}
  .field{margin-bottom:14px}
  .field label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
  .field input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:12px 14px;font-family:var(--mono);font-size:14px;border-radius:6px;outline:none}
  .field input:focus{border-color:var(--accent)}
  .modal-btns{display:flex;gap:10px;margin-top:20px}
  .modal-btns button{flex:1;padding:14px;font-family:var(--mono);font-size:14px;font-weight:500;cursor:pointer;border-radius:8px;border:1px solid var(--border);min-height:48px}
  .btn-cancel{background:var(--surface2);color:var(--text-dim)}
  .btn-create{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}

  /* === DESKTOP (>768px) === */
  @media(min-width:769px){
    .quick-bar{display:none !important}
    .main{display:flex;flex:1;overflow:hidden;min-height:0}
    .header{padding:12px 20px}
    .terminal-header{padding:10px 20px}
    .terminal-output{padding:16px 20px}
    .terminal-input-area{padding:12px 20px}
    .terminal-input{background:transparent;border:none;padding:0;border-radius:0}
    .terminal-input:focus{border-color:transparent}
    .btn-send{display:none}
    .btn-action{padding:4px 10px;font-size:11px}
    .session-card{padding:10px 12px;min-height:auto}
    .quick-btn{padding:4px 8px;font-size:11px}
    .modal{border-radius:6px;max-width:380px}
    .modal-overlay{align-items:center}
  }

  /* === MOBILE (<768px) === */
  @media(max-width:768px){
    .main{display:flex;flex-direction:column;flex:1;min-height:0}
    .quick-bar{display:block}
    .header-right .port-label{display:none}
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <button class="btn-menu" onclick="toggleDrawer()" aria-label="Menu">☰</button>
    <div class="status-dot"></div>
    <div class="logo">WINRM <span>// HIVE</span></div>
  </div>
  <div class="header-right">
    <span class="port-label">:8775</span>
    <span class="session-count" id="sessionCount">0</span> sessions
    <button class="btn-menu" onclick="showHelp()" title="Help" style="margin-left:8px">?</button>
  </div>
</div>

<!-- Mobile quick connect bar -->
<div class="quick-bar" id="quickBar">
  <span class="qb" onclick="quickConnect('localhost')">⚡ Local</span>
  <span class="qb" onclick="quickConnect('192.168.1.42')">Harold-PC</span>
  <span class="qb" onclick="quickConnect('192.168.1.97')">Morpu-PC</span>
  <span class="qb" onclick="quickConnect('192.168.1.162')">AI-PC</span>
  <span class="qb" onclick="quickConnect('192.168.1.192')">Rock-PC</span>
  <span class="qb" onclick="showNewSession()">+ New</span>
</div>

<!-- Drawer overlay -->
<div class="drawer-overlay" id="drawerOverlay" onclick="toggleDrawer()"></div>

<div class="main">
  <!-- Sidebar (drawer on mobile) -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Sessions</span>
      <button class="btn-new" onclick="showNewSession()">+ NEW</button>
    </div>
    <div class="sessions-list" id="sessionsList">
      <div class="no-sessions">No active sessions.<br>Create one to begin.</div>
    </div>
    <div class="quick-connect">
      <div class="quick-label">Quick Connect</div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickConnect('localhost')">localhost</button>
        <button class="quick-btn" onclick="quickConnect('192.168.1.42')">Harold-PC</button>
        <button class="quick-btn" onclick="quickConnect('192.168.1.97')">Morpu-PC</button>
        <button class="quick-btn" onclick="quickConnect('192.168.1.162')">AI-PC</button>
        <button class="quick-btn" onclick="quickConnect('192.168.1.192')">Rock-PC</button>
      </div>
    </div>
  </div>

  <!-- Terminal -->
  <div class="terminal-area">
    <div class="session-tabs" id="sessionTabs"></div>
    <div class="terminal-header">
      <div class="terminal-title" id="terminalTitle">Select or create a session</div>
      <div class="terminal-actions">
        <button class="btn-action broadcast" onclick="broadcastCmd()">⚡ ALL</button>
        <button class="btn-action stop" id="btnCancel" onclick="cancelCmd()" style="display:none">⏹ STOP</button>
        <button class="btn-action danger" id="btnClose" onclick="closeSession()" style="display:none">✕</button>
      </div>
    </div>
    <div class="terminal-output" id="output">
      <div class="welcome-msg">
        <div class="big">WinRM Bridge</div>
        <div style="margin:16px 0;text-align:left;max-width:400px;display:inline-block">
          <div style="color:var(--accent);font-weight:600;margin-bottom:8px">Quick Start</div>
          <div style="line-height:1.8;font-size:12px">
            1. Tap <b>⚡ Local</b> or a machine above<br>
            2. Type PowerShell commands<br>
            3. Press Enter or tap <b>▶</b> to execute
          </div>
          <div style="color:var(--accent);font-weight:600;margin:12px 0 8px">Features</div>
          <div style="line-height:1.8;font-size:12px">
            <b>⏹ STOP</b> - Cancel stuck commands<br>
            <b>⚡ ALL</b> - Broadcast to all sessions<br>
            <b>30s timeout</b> - Auto-cancels long commands<br>
            <b>↑↓ arrows</b> - Command history
          </div>
          <div style="color:var(--accent);font-weight:600;margin:12px 0 8px">Remote Sessions</div>
          <div style="line-height:1.8;font-size:12px">
            Tap <b>+ New</b> to connect to remote<br>
            machines via WinRM with credentials
          </div>
        </div>
      </div>
    </div>
    <div class="terminal-input-area">
      <span class="prompt">❯</span>
      <input class="terminal-input" id="cmdInput" placeholder="PowerShell command..." disabled
             onkeydown="if(event.key==='Enter'){event.preventDefault();execCmd()}"
             enterkeyhint="send" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button class="btn-send" id="btnSend" onclick="execCmd()" disabled>▶</button>
    </div>
  </div>
</div>

<!-- New Session Modal -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)hideModal()">
  <div class="modal">
    <h3>New Session</h3>
    <div class="field"><label>Computer</label><input id="modalComputer" value="localhost" placeholder="hostname or IP" enterkeyhint="next"></div>
    <div class="field"><label>Label</label><input id="modalLabel" placeholder="e.g. Harold-PC Shell" enterkeyhint="next"></div>
    <div class="field"><label>Username (remote)</label><input id="modalUser" placeholder="DOMAIN\\user" enterkeyhint="next"></div>
    <div class="field"><label>Password (remote)</label><input id="modalPass" type="password" placeholder="password" enterkeyhint="done"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="hideModal()">Cancel</button>
      <button class="btn-create" onclick="createSession()">Create</button>
    </div>
  </div>
</div>

<script>
const API='';
const WS_BASE = `${location.protocol==='https:'?'wss:':'ws:'}//${location.host}`;
let sessions=[],activeSession=null,hist={},cmdHistory=[],cmdHistoryIdx=-1;
let ws=null; // WebSocket connection

function toggleDrawer(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('drawerOverlay').classList.toggle('show');
}
function closeDrawer(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('show');
}

async function api(path,opts={}){
  const r=await fetch(API+path,{headers:{'Content-Type':'application/json'},...opts,body:opts.body?JSON.stringify(opts.body):undefined});
  return r.json();
}

async function refreshSessions(){
  const d=await api('/sessions');sessions=d.sessions||[];
  document.getElementById('sessionCount').textContent=sessions.length;
  renderSessions();
}

function renderSessions(){
  const el=document.getElementById('sessionsList');
  const tabs=document.getElementById('sessionTabs');
  if(!sessions.length){
    el.innerHTML='<div class="no-sessions">No active sessions.<br>Create one to begin.</div>';
    tabs.innerHTML='';
    return;
  }
  el.innerHTML=sessions.map(s=>`
    <div class="session-card ${activeSession===s.sessionId?'active':''}" onclick="selectSession('${s.sessionId}')">
      <div class="session-label">${esc(s.label)}${s.running?' <span class="session-running">⏳</span>':''}</div>
      <div class="session-meta">
        <span class="computer">${esc(s.computer)}</span>
        <span class="cmds">${s.commandCount} cmds</span>
        <span>${s.running?fmtUp(s.running.elapsed)+' running':fmtUp(s.uptime)}</span>
      </div>
    </div>`).join('');
  tabs.innerHTML=sessions.map(s=>`
    <div class="stab ${activeSession===s.sessionId?'active':''}" onclick="selectSession('${s.sessionId}')">
      <span class="sdot" style="${s.running?'background:var(--accent);box-shadow:0 0 8px var(--accent)':''}"></span>
      ${esc(s.label)}${s.running?' ⏳':''}
      <span class="sclose" onclick="event.stopPropagation();closeSessionById('${s.sessionId}')">✕</span>
    </div>`).join('');
}

function selectSession(id){
  // Close existing WebSocket
  if(ws){ws.close();ws=null;}

  activeSession=id;
  const s=sessions.find(x=>x.sessionId===id);
  document.getElementById('terminalTitle').innerHTML=`<span class="name">${esc(s.label)}</span> — ${esc(s.computer)}`;
  document.getElementById('btnClose').style.display='';
  document.getElementById('cmdInput').disabled=false;
  document.getElementById('btnSend').disabled=false;
  closeDrawer();
  renderOutput();renderSessions();

  // Connect WebSocket for streaming
  connectWebSocket(id);

  // Don't auto-focus on mobile (prevents keyboard popup)
  if(window.innerWidth>768) document.getElementById('cmdInput').focus();
}

function connectWebSocket(sessionId){
  ws=new WebSocket(`${WS_BASE}?session=${sessionId}`);
  ws.onopen=()=>{console.log('WebSocket connected')};
  ws.onmessage=(e)=>{
    try{
      const msg=JSON.parse(e.data);
      if(msg.type==='output'){
        appendStreamOutput(msg.data);
      }else if(msg.type==='result'){
        document.getElementById('btnCancel').style.display='none';
        document.getElementById('cmdInput').disabled=false;
        document.getElementById('btnSend').disabled=false;
        refreshSessions();
      }else if(msg.type==='interrupted'){
        appendStreamOutput('[Interrupted]\n');
        document.getElementById('btnCancel').style.display='none';
        document.getElementById('cmdInput').disabled=false;
        document.getElementById('btnSend').disabled=false;
      }else if(msg.type==='error'){
        appendStreamOutput(`[Error: ${msg.message}]\n`);
      }
    }catch(err){console.error('WS parse error:',err)}
  };
  ws.onclose=()=>{console.log('WebSocket disconnected')};
  ws.onerror=(e)=>{console.error('WebSocket error:',e)};
}

function appendStreamOutput(text){
  const el=document.getElementById('output');
  // Create or get streaming div
  let streamDiv=document.getElementById('streamOutput');
  if(!streamDiv){
    el.innerHTML='';
    streamDiv=document.createElement('pre');
    streamDiv.id='streamOutput';
    streamDiv.style.cssText='white-space:pre-wrap;word-break:break-word;margin:0;font-size:12px;color:var(--text)';
    el.appendChild(streamDiv);
  }
  streamDiv.textContent+=text;
  el.scrollTop=el.scrollHeight;
}

function renderOutput(){
  const el=document.getElementById('output'),entries=hist[activeSession]||[];
  if(!entries.length){el.innerHTML='<div class="output-info">Session ready. Type a command.</div>'}
  else{el.innerHTML=entries.map(e=>`
    <div class="output-entry">
      <div class="output-cmd">${esc(e.cmd)} <span class="output-time">${e.time}ms</span></div>
      <div class="output-result ${e.error?'output-error':''}">${esc(e.output)}</div>
    </div>`).join('')}
  el.scrollTop=el.scrollHeight;
}

async function execCmd(){
  const input=document.getElementById('cmdInput'),cmd=input.value.trim();
  if(!cmd||!activeSession)return;
  input.value='';cmdHistory.unshift(cmd);cmdHistoryIdx=-1;

  // Show cancel button, disable input
  document.getElementById('btnCancel').style.display='';
  document.getElementById('cmdInput').disabled=true;
  document.getElementById('btnSend').disabled=true;

  // Use WebSocket if connected, otherwise fall back to REST
  if(ws && ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'exec',command:cmd,timeout:30000}));
  }else{
    // Fallback to REST API
    if(!hist[activeSession])hist[activeSession]=[];
    const idx=hist[activeSession].length;
    hist[activeSession].push({cmd,output:'⏳ executing...',time:'',error:false});
    renderOutput();
    try{
      const d=await api(`/session/${activeSession}/exec`,{method:'POST',body:{command:cmd}});
      hist[activeSession][idx]={cmd,output:d.success?(d.output||'(no output)'):d.error,time:d.executionTime||'?',error:!d.success};
      if(d.timedOut)hist[activeSession][idx].output='⏱ '+hist[activeSession][idx].output;
      if(d.cancelled)hist[activeSession][idx].output='⏹ '+hist[activeSession][idx].output;
    }catch(err){hist[activeSession][idx]={cmd,output:err.message,time:'—',error:true}}
    document.getElementById('btnCancel').style.display='none';
    document.getElementById('cmdInput').disabled=false;
    document.getElementById('btnSend').disabled=false;
    renderOutput();refreshSessions();
  }
}

async function cancelCmd(){
  if(!activeSession)return;
  // Use WebSocket if connected
  if(ws && ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'interrupt'}));
  }else{
    try{
      await api(`/session/${activeSession}/cancel`,{method:'POST'});
    }catch(err){console.log('Cancel failed:',err)}
  }
  document.getElementById('btnCancel').style.display='none';
}

async function broadcastCmd(){
  const cmd=prompt('Broadcast to ALL sessions:');
  if(!cmd||!sessions.length)return;
  for(const s of sessions){if(!hist[s.sessionId])hist[s.sessionId]=[];hist[s.sessionId].push({cmd:`[ALL] ${cmd}`,output:'⏳...',time:'',error:false})}
  renderOutput();
  const d=await api('/sessions/exec-all',{method:'POST',body:{command:cmd}});
  for(const r of(d.results||[])){const h=hist[r.sessionId];if(h)h[h.length-1]={cmd:`[ALL] ${cmd}`,output:r.success?(r.output||'(no output)'):r.error,time:r.executionTime||'?',error:!r.success}}
  renderOutput();refreshSessions();
}

async function closeSession(){
  if(!activeSession||!confirm('Close session?'))return;
  await closeSessionById(activeSession);
}

async function closeSessionById(id){
  await api(`/session/${id}`,{method:'DELETE'});
  delete hist[id];
  if(activeSession===id){
    activeSession=null;
    document.getElementById('terminalTitle').textContent='Select or create a session';
    document.getElementById('btnClose').style.display='none';
    document.getElementById('btnCancel').style.display='none';
    document.getElementById('cmdInput').disabled=true;
    document.getElementById('btnSend').disabled=true;
    document.getElementById('output').innerHTML='<div class="welcome-msg"><div class="big">Session Closed</div></div>';
  }
  await refreshSessions();
  // Auto-select another session if available
  if(!activeSession&&sessions.length) selectSession(sessions[0].sessionId);
}

function showNewSession(){closeDrawer();document.getElementById('modal').classList.add('show')}
function hideModal(){document.getElementById('modal').classList.remove('show')}

async function createSession(){
  const computer=document.getElementById('modalComputer').value.trim()||'localhost';
  const label=document.getElementById('modalLabel').value.trim();
  const user=document.getElementById('modalUser').value.trim();
  const pass=document.getElementById('modalPass').value;
  const body={computer};if(label)body.label=label;
  if(user&&pass)body.credentials={username:user,password:pass};
  const d=await api('/session/create',{method:'POST',body});
  hideModal();
  if(d.success){await refreshSessions();selectSession(d.sessionId)}
  else{alert('Failed: '+d.error)}
  document.getElementById('modalLabel').value='';
  document.getElementById('modalUser').value='';
  document.getElementById('modalPass').value='';
}

async function quickConnect(computer){
  const names={'localhost':'Local','192.168.1.42':'Harold-PC','192.168.1.97':'Morpu-PC','192.168.1.162':'AI-PC','192.168.1.192':'Rock-PC'};
  const d=await api('/session/create',{method:'POST',body:{computer,label:names[computer]||computer}});
  if(d.success){await refreshSessions();selectSession(d.sessionId)}
  else{alert('Failed: '+d.error)}
}

// Keyboard history (desktop)
document.getElementById('cmdInput').addEventListener('keydown',e=>{
  if(e.key==='ArrowUp'){e.preventDefault();if(cmdHistoryIdx<cmdHistory.length-1){cmdHistoryIdx++;e.target.value=cmdHistory[cmdHistoryIdx]}}
  if(e.key==='ArrowDown'){e.preventDefault();if(cmdHistoryIdx>0){cmdHistoryIdx--;e.target.value=cmdHistory[cmdHistoryIdx]}else{cmdHistoryIdx=-1;e.target.value=''}}
});

// Handle mobile keyboard resize
if(window.visualViewport){
  window.visualViewport.addEventListener('resize',()=>{
    document.body.style.height=window.visualViewport.height+'px';
  });
  window.visualViewport.addEventListener('scroll',()=>{
    document.body.style.height=window.visualViewport.height+'px';
  });
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function fmtUp(ms){const s=Math.floor(ms/1000);if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';return Math.floor(s/3600)+'h'}

function showHelp(){
  const help=`
<div style="text-align:left;line-height:1.8">
<h3 style="color:var(--accent);margin:0 0 12px">WinRM Bridge Help</h3>

<b style="color:var(--accent)">Keyboard Shortcuts</b>
<div style="margin:4px 0 12px;font-size:12px">
  <b>Enter</b> - Execute command<br>
  <b>↑ / ↓</b> - Navigate command history<br>
  <b>Ctrl+C</b> - In terminal, same as STOP
</div>

<b style="color:var(--accent)">Buttons</b>
<div style="margin:4px 0 12px;font-size:12px">
  <b>⚡ Local</b> - Quick connect to localhost<br>
  <b>⏹ STOP</b> - Cancel running command (Ctrl+C)<br>
  <b>⚡ ALL</b> - Run command on all sessions<br>
  <b>+ NEW</b> - Create session (local or remote)
</div>

<b style="color:var(--accent)">Timeout</b>
<div style="margin:4px 0 12px;font-size:12px">
  Commands auto-cancel after 30 seconds.<br>
  Use STOP button to cancel earlier.
</div>

<b style="color:var(--accent)">Remote Sessions</b>
<div style="margin:4px 0 12px;font-size:12px">
  Click + NEW, enter hostname/IP and<br>
  credentials to connect via WinRM.
</div>

<b style="color:var(--accent)">API</b>
<div style="margin:4px 0;font-size:12px">
  REST: <code>http://localhost:8775/sessions</code><br>
  WebSocket: <code>ws://localhost:8775?session=ID</code>
</div>
</div>`;
  document.getElementById('output').innerHTML='<div class="welcome-msg" style="padding:20px">'+help+'</div>';
}

refreshSessions();setInterval(refreshSessions,10000);
</script>
</body>
</html>