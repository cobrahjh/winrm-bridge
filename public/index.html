<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0c">
<title>WinRM Bridge // Hive</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;600;800&display=swap');
  :root {
    --bg:#0a0a0c;--surface:#111114;--surface2:#18181c;--border:#2a2a30;
    --text:#c8c8d0;--text-dim:#66666e;--accent:#f59e0b;--accent-dim:#78500d;
    --green:#22c55e;--red:#ef4444;--blue:#3b82f6;
    --mono:'JetBrains Mono',monospace;--sans:'Outfit',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;overflow:hidden;touch-action:manipulation}
  body{font-family:var(--mono);background:var(--bg);color:var(--text);display:flex;flex-direction:column}

  /* HEADER */
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;min-height:48px}
  .header-left{display:flex;align-items:center;gap:10px}
  .btn-menu{background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:4px 8px;line-height:1}
  .logo{font-family:var(--sans);font-weight:800;font-size:15px;color:var(--accent);letter-spacing:-0.5px}
  .logo span{color:var(--text-dim);font-weight:300}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .header-right{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-dim)}
  .session-count{color:var(--accent);font-weight:500}

  /* QUICK CONNECT BAR (mobile) */
  .quick-bar{display:block;flex-shrink:0;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .quick-bar::-webkit-scrollbar{display:none}
  .quick-bar .qb{display:inline-block;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 14px;font-family:var(--mono);font-size:13px;cursor:pointer;border-radius:6px;margin-right:6px;transition:all .15s;-webkit-user-select:none;user-select:none}
  .quick-bar .qb:active{background:var(--accent);color:#000;border-color:var(--accent)}

  /* DRAWER OVERLAY */
  .drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:50}
  .drawer-overlay.show{display:block}

  /* SIDEBAR / DRAWER */
  .sidebar{position:fixed;top:0;left:-300px;width:300px;height:100%;z-index:60;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);transition:left .25s ease;overflow:hidden}
  .sidebar.open{left:0}
  .sidebar-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;min-height:52px}
  .sidebar-title{font-size:12px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim)}
  .btn-new{background:var(--accent);color:#000;border:none;padding:8px 14px;font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer;border-radius:4px}
  .btn-new:active{background:#fbbf24}
  .sessions-list{flex:1;overflow-y:auto;padding:8px;-webkit-overflow-scrolling:touch}
  .session-card{padding:14px;border:1px solid transparent;border-radius:6px;cursor:pointer;margin-bottom:6px;transition:all .15s;min-height:48px}
  .session-card:active{background:var(--surface2);border-color:var(--border)}
  .session-card.active{background:var(--surface2);border-color:var(--accent-dim)}
  .session-label{font-size:14px;font-weight:500;color:var(--text)}
  .session-meta{font-size:12px;color:var(--text-dim);margin-top:4px;display:flex;gap:12px}
  .session-meta .computer{color:var(--blue)}
  .session-meta .cmds{color:var(--accent)}
  .no-sessions{padding:30px 16px;text-align:center;color:var(--text-dim);font-size:13px;line-height:1.6}
  .quick-connect{padding:14px 16px;border-top:1px solid var(--border)}
  .quick-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:8px}
  .quick-btns{display:flex;flex-wrap:wrap;gap:6px}
  .quick-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 14px;font-family:var(--mono);font-size:13px;cursor:pointer;border-radius:6px;transition:all .15s}
  .quick-btn:active{border-color:var(--accent);color:var(--accent)}

  /* SESSION TABS */
  .session-tabs{display:flex;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;min-height:0}
  .session-tabs::-webkit-scrollbar{display:none}
  .session-tabs:empty{display:none}
  .stab{display:flex;align-items:center;gap:6px;padding:10px 14px;font-family:var(--mono);font-size:12px;color:var(--text-dim);cursor:pointer;border-right:1px solid var(--border);white-space:nowrap;transition:all .15s;min-height:40px;-webkit-user-select:none;user-select:none}
  .stab:active,.stab:hover{background:var(--surface2);color:var(--text)}
  .stab.active{color:var(--accent);background:var(--bg);border-bottom:2px solid var(--accent)}
  .stab .sdot{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0}
  .stab .sclose{color:var(--text-dim);font-size:14px;margin-left:4px;padding:2px 4px;border-radius:3px;line-height:1}
  .stab .sclose:hover,.stab .sclose:active{color:var(--red);background:var(--surface2)}

  /* TERMINAL AREA */
  .terminal-area{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;min-height:0;overflow:hidden}
  .terminal-header{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);min-height:44px;flex-shrink:0;gap:8px}
  .terminal-title{font-size:12px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
  .terminal-title .name{color:var(--accent);font-weight:500}
  .terminal-actions{display:flex;gap:6px;flex-shrink:0}
  .btn-action{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px 12px;font-family:var(--mono);font-size:12px;cursor:pointer;border-radius:4px;white-space:nowrap}
  .btn-action:active{border-color:var(--text-dim);color:var(--text)}
  .btn-action.danger:active{border-color:var(--red);color:var(--red)}
  .btn-action.broadcast{color:var(--accent);border-color:var(--accent-dim)}
  .btn-action.broadcast:active{background:var(--accent);color:#000}
  .btn-action.stop{background:var(--red);color:#fff;border-color:var(--red);animation:pulse-red 1s infinite}
  @keyframes pulse-red{0%,100%{opacity:1}50%{opacity:.7}}
  .session-running{color:var(--accent);font-size:11px;animation:pulse 1s infinite}

  /* OUTPUT */
  .terminal-output{flex:1;overflow-y:auto;padding:0;font-size:13px;line-height:1.65;-webkit-overflow-scrolling:touch;min-height:0;position:relative}
  .output-entry{margin-bottom:14px;overflow-wrap:break-word;word-break:break-word}
  .output-cmd{color:var(--accent);font-weight:500}
  .output-cmd::before{content:'‚ùØ ';color:var(--text-dim)}
  .output-result{color:var(--text);white-space:pre-wrap;overflow-wrap:break-word;margin-top:4px;padding-left:2px;font-size:12px}
  .output-error{color:var(--red)}
  .output-info{color:var(--text-dim);font-style:italic}
  .output-time{color:var(--text-dim);font-size:11px;float:right}
  .welcome-msg{color:var(--text-dim);padding:40px 20px;text-align:center;font-size:13px;line-height:2}
  .welcome-msg .big{font-family:var(--sans);font-size:22px;font-weight:600;color:var(--text)}
  /* xterm.js container */
  #xterm-container{display:none;width:100%;height:100%}
  #xterm-container.active{display:block}
  .xterm{height:100% !important}
  .xterm-viewport{overflow-y:auto !important}

  /* INPUT */
  .terminal-input-area{padding:10px 12px;border-top:1px solid var(--border);background:var(--surface);display:flex;align-items:center;gap:8px;flex-shrink:0}
  .prompt{color:var(--accent);font-weight:700;font-size:14px}
  .terminal-input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:14px;outline:none;caret-color:var(--accent);padding:10px 12px;border-radius:6px;min-width:0}
  .terminal-input:focus{border-color:var(--accent)}
  .terminal-input::placeholder{color:var(--text-dim)}
  .terminal-input:disabled{opacity:.4}
  .btn-send{background:var(--accent);color:#000;border:none;padding:10px 16px;font-family:var(--mono);font-size:14px;font-weight:700;cursor:pointer;border-radius:6px;flex-shrink:0;min-width:48px;min-height:44px}
  .btn-send:active{background:#fbbf24}
  .btn-send:disabled{opacity:.3}

  /* MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:flex-end;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:12px 12px 0 0;padding:24px 20px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
  .modal h3{font-family:var(--sans);font-weight:600;font-size:18px;margin-bottom:18px;color:var(--accent)}
  .field{margin-bottom:14px}
  .field label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
  .field input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:12px 14px;font-family:var(--mono);font-size:14px;border-radius:6px;outline:none}
  .field input:focus{border-color:var(--accent)}
  .modal-btns{display:flex;gap:10px;margin-top:20px}
  .modal-btns button{flex:1;padding:14px;font-family:var(--mono);font-size:14px;font-weight:500;cursor:pointer;border-radius:8px;border:1px solid var(--border);min-height:48px}
  .btn-cancel{background:var(--surface2);color:var(--text-dim)}
  .btn-create{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}

  /* === DESKTOP (>768px) === */
  @media(min-width:769px){
    .quick-bar{display:none !important}
    .main{display:flex;flex:1;overflow:hidden;min-height:0}
    .header{padding:12px 20px}
    .terminal-header{padding:10px 20px}
    .terminal-output{padding:0}
    .terminal-input-area{padding:12px 20px}
    .terminal-input{background:transparent;border:none;padding:0;border-radius:0}
    .terminal-input:focus{border-color:transparent}
    .btn-send{display:none}
    .btn-action{padding:4px 10px;font-size:11px}
    .session-card{padding:10px 12px;min-height:auto}
    .quick-btn{padding:4px 8px;font-size:11px}
    .modal{border-radius:6px;max-width:380px}
    .modal-overlay{align-items:center}
  }

  /* === MOBILE (<768px) === */
  @media(max-width:768px){
    .main{display:flex;flex-direction:column;flex:1;min-height:0}
    .quick-bar{display:block}
    .header-right .port-label{display:none}
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <button class="btn-menu" onclick="toggleDrawer()" aria-label="Menu">‚ò∞</button>
    <div class="status-dot"></div>
    <div class="logo">WINRM <span>// HIVE</span></div>
  </div>
  <div class="header-right">
    <span class="port-label">:8775</span>
    <span class="session-count" id="sessionCount">0</span> sessions
    <button class="btn-menu" onclick="showHelp()" title="Help" style="margin-left:8px">?</button>
  </div>
</div>

<!-- Mobile quick connect bar -->
<div class="quick-bar" id="quickBar">
  <span class="qb" onclick="quickLocal('powershell')">‚ö° PS</span>
  <span class="qb" onclick="quickLocal('cmd')">CMD</span>
  <span class="qb" onclick="quickLocal('bash')">Bash</span>
  <span class="qb" style="opacity:0.5">|</span>
  <span class="qb" onclick="quickConnect('192.168.1.42')">Harold</span>
  <span class="qb" onclick="quickConnect('192.168.1.97')">Morpu</span>
  <span class="qb" onclick="showNewSession()">+ New</span>
</div>

<!-- Drawer overlay -->
<div class="drawer-overlay" id="drawerOverlay" onclick="toggleDrawer()"></div>

<div class="main">
  <!-- Sidebar (drawer on mobile) -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Sessions</span>
      <button class="btn-new" onclick="showNewSession()">+ NEW</button>
    </div>
    <div class="sessions-list" id="sessionsList">
      <div class="no-sessions">No active sessions.<br>Create one to begin.</div>
    </div>
    <div class="quick-connect">
      <div class="quick-label">Local Terminals</div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickLocal('powershell')">PowerShell</button>
        <button class="quick-btn" onclick="quickLocal('cmd')">CMD</button>
        <button class="quick-btn" onclick="quickLocal('bash')">Git Bash</button>
      </div>
      <div class="quick-label" style="margin-top:10px">Remote (WinRM)</div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickConnect('192.168.1.42')">Harold-PC</button>
        <button class="quick-btn" onclick="quickConnect('192.168.1.97')">Morpu-PC</button>
      </div>
    </div>
  </div>

  <!-- Terminal -->
  <div class="terminal-area">
    <div class="session-tabs" id="sessionTabs"></div>
    <div class="terminal-header">
      <div class="terminal-title" id="terminalTitle">Select or create a session</div>
      <div class="terminal-actions">
        <button class="btn-action broadcast" onclick="broadcastCmd()">‚ö° ALL</button>
        <button class="btn-action stop" id="btnCancel" onclick="cancelCmd()" style="display:none">‚èπ STOP</button>
        <button class="btn-action danger" id="btnClose" onclick="closeSession()" style="display:none">‚úï</button>
      </div>
    </div>
    <div class="terminal-output" id="output">
      <div id="xterm-container"></div>
      <div id="welcome-msg" class="welcome-msg">
        <div class="big">WinRM Bridge</div>
        <div style="margin:16px 0;text-align:left;max-width:400px;display:inline-block">
          <div style="color:var(--accent);font-weight:600;margin-bottom:8px">Quick Start</div>
          <div style="line-height:1.8;font-size:12px">
            1. Tap <b>‚ö° Local</b> or a machine above<br>
            2. Type PowerShell commands<br>
            3. Press Enter or tap <b>‚ñ∂</b> to execute
          </div>
          <div style="color:var(--accent);font-weight:600;margin:12px 0 8px">Features</div>
          <div style="line-height:1.8;font-size:12px">
            <b>‚èπ STOP</b> - Cancel stuck commands<br>
            <b>‚ö° ALL</b> - Broadcast to all sessions<br>
            <b>30s timeout</b> - Auto-cancels long commands<br>
            <b>‚Üë‚Üì arrows</b> - Command history
          </div>
          <div style="color:var(--accent);font-weight:600;margin:12px 0 8px">Remote Sessions</div>
          <div style="line-height:1.8;font-size:12px">
            Tap <b>+ New</b> to connect to remote<br>
            machines via WinRM with credentials
          </div>
        </div>
      </div>
    </div>
    <div class="terminal-input-area" id="inputArea">
      <span class="prompt">‚ùØ</span>
      <input class="terminal-input" id="cmdInput" placeholder="PowerShell command..." disabled
             onkeydown="if(event.key==='Enter'){event.preventDefault();execCmd()}"
             enterkeyhint="send" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <select id="timeoutSelect" title="Command timeout" style="background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px;font-family:var(--mono);font-size:11px;border-radius:4px;cursor:pointer">
        <option value="10000">10s</option>
        <option value="30000" selected>30s</option>
        <option value="60000">1m</option>
        <option value="120000">2m</option>
        <option value="300000">5m</option>
        <option value="0">‚àû</option>
      </select>
      <button class="btn-send" id="btnSend" onclick="execCmd()" disabled>‚ñ∂</button>
    </div>
  </div>
</div>

<!-- New Session Modal -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)hideModal()">
  <div class="modal">
    <h3>New Session</h3>
    <div class="field"><label>Computer</label><input id="modalComputer" value="localhost" placeholder="hostname or IP" enterkeyhint="next"></div>
    <div class="field"><label>Label</label><input id="modalLabel" placeholder="e.g. Harold-PC Shell" enterkeyhint="next"></div>
    <div class="field"><label>Username (remote)</label><input id="modalUser" placeholder="DOMAIN\\user" enterkeyhint="next"></div>
    <div class="field"><label>Password (remote)</label><input id="modalPass" type="password" placeholder="password" enterkeyhint="done"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="hideModal()">Cancel</button>
      <button class="btn-create" onclick="createSession()">Create</button>
    </div>
  </div>
</div>

<script>
const API='';
const WS_BASE = `${location.protocol==='https:'?'wss:':'ws:'}//${location.host}`;
let sessions=[],activeSession=null,hist={},cmdHistory=[],cmdHistoryIdx=-1;
let ws=null; // WebSocket connection
let term=null,fitAddon=null; // xterm.js terminal
let isLocalSession=false;

// Initialize xterm.js terminal
function initXterm(){
  if(term){term.dispose()}
  term=new Terminal({
    cursorBlink:true,
    fontSize:13,
    fontFamily:'JetBrains Mono, Consolas, monospace',
    lineHeight:1.2,
    theme:{
      background:'#0a0a0c',
      foreground:'#c8c8d0',
      cursor:'#f59e0b',
      cursorAccent:'#0a0a0c',
      selectionBackground:'rgba(245,158,11,0.3)',
      black:'#0a0a0c',
      red:'#ef4444',
      green:'#22c55e',
      yellow:'#f59e0b',
      blue:'#3b82f6',
      magenta:'#a855f7',
      cyan:'#06b6d4',
      white:'#c8c8d0',
      brightBlack:'#66666e',
      brightRed:'#f87171',
      brightGreen:'#4ade80',
      brightYellow:'#fbbf24',
      brightBlue:'#60a5fa',
      brightMagenta:'#c084fc',
      brightCyan:'#22d3ee',
      brightWhite:'#f8f8f8'
    }
  });
  fitAddon=new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.loadAddon(new WebLinksAddon.WebLinksAddon());
  term.open(document.getElementById('xterm-container'));
  fitAddon.fit();

  // Handle keyboard input from xterm (for local sessions)
  term.onData((data)=>{
    if(ws&&ws.readyState===WebSocket.OPEN&&isLocalSession){
      ws.send(JSON.stringify({type:'input',data}));
    }
  });
}

// Handle window resize for xterm
window.addEventListener('resize',()=>{
  if(fitAddon&&term){
    fitAddon.fit();
    if(ws&&ws.readyState===WebSocket.OPEN&&isLocalSession){
      ws.send(JSON.stringify({type:'resize',cols:term.cols,rows:term.rows}));
    }
  }
});

function showXterm(){
  document.getElementById('xterm-container').classList.add('active');
  document.getElementById('welcome-msg').style.display='none';
  if(fitAddon)setTimeout(()=>fitAddon.fit(),10);
}

function hideXterm(){
  document.getElementById('xterm-container').classList.remove('active');
  document.getElementById('welcome-msg').style.display='';
}

function toggleDrawer(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('drawerOverlay').classList.toggle('show');
}
function closeDrawer(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('show');
}

async function api(path,opts={}){
  const r=await fetch(API+path,{headers:{'Content-Type':'application/json'},...opts,body:opts.body?JSON.stringify(opts.body):undefined});
  return r.json();
}

async function refreshSessions(){
  const d=await api('/sessions');sessions=d.sessions||[];
  document.getElementById('sessionCount').textContent=sessions.length;
  renderSessions();
}

function renderSessions(){
  const el=document.getElementById('sessionsList');
  const tabs=document.getElementById('sessionTabs');
  if(!sessions.length){
    el.innerHTML='<div class="no-sessions">No active sessions.<br>Create one to begin.</div>';
    tabs.innerHTML='';
    return;
  }
  const typeIcon=(s)=>s.type==='local'?'‚å®':'üåê';
  el.innerHTML=sessions.map(s=>`
    <div class="session-card ${activeSession===s.sessionId?'active':''}" onclick="selectSession('${s.sessionId}')">
      <div class="session-label">${typeIcon(s)} ${esc(s.label)}${s.running?' <span class="session-running">‚è≥</span>':''}${s.alive===false?' <span style="color:var(--red)">‚úó</span>':''}</div>
      <div class="session-meta">
        <span class="computer">${s.type==='local'?(s.shell||'shell'):esc(s.computer)}</span>
        <span class="cmds">${s.commandCount} cmds</span>
        <span>${s.running?fmtUp(s.running.elapsed)+' running':fmtUp(s.uptime)}</span>
      </div>
    </div>`).join('');
  tabs.innerHTML=sessions.map(s=>`
    <div class="stab ${activeSession===s.sessionId?'active':''}" onclick="selectSession('${s.sessionId}')">
      <span class="sdot" style="${s.running?'background:var(--accent);box-shadow:0 0 8px var(--accent)':''}"></span>
      ${typeIcon(s)} ${esc(s.label)}${s.running?' ‚è≥':''}
      <span class="sclose" onclick="event.stopPropagation();closeSessionById('${s.sessionId}')">‚úï</span>
    </div>`).join('');
}

function selectSession(id){
  // Close existing WebSocket
  if(ws){ws.close();ws=null;}

  activeSession=id;
  const s=sessions.find(x=>x.sessionId===id);
  isLocalSession = s.type === 'local';
  const typeIcon = isLocalSession ? '‚å®' : 'üåê';
  document.getElementById('terminalTitle').innerHTML=`${typeIcon} <span class="name">${esc(s.label)}</span> ‚Äî ${isLocalSession ? (s.shell||'shell') : esc(s.computer)}`;
  document.getElementById('btnClose').style.display='';
  // Show STOP button for local terminals (always available for Ctrl+C)
  document.getElementById('btnCancel').style.display = isLocalSession ? '' : 'none';
  closeDrawer();

  // Initialize xterm if needed
  if(!term)initXterm();
  term.clear();
  term.reset();
  showXterm();

  // For local sessions: hide command input (xterm handles input)
  // For WinRM sessions: show command input
  const inputArea=document.getElementById('inputArea');
  if(isLocalSession){
    inputArea.style.display='none';
  }else{
    inputArea.style.display='';
    document.getElementById('cmdInput').disabled=false;
    document.getElementById('btnSend').disabled=false;
  }

  // Connect WebSocket for streaming
  connectWebSocket(id);

  // Focus xterm for local sessions, input for WinRM
  if(window.innerWidth>768){
    if(isLocalSession){
      term.focus();
    }else{
      document.getElementById('cmdInput').focus();
    }
  }
}

function connectWebSocket(sessionId){
  ws=new WebSocket(`${WS_BASE}?session=${sessionId}`);
  ws.onopen=()=>{
    console.log('WebSocket connected');
    // Send initial terminal size for local sessions
    if(isLocalSession&&term){
      ws.send(JSON.stringify({type:'resize',cols:term.cols,rows:term.rows}));
    }
  };
  ws.onmessage=(e)=>{
    try{
      const msg=JSON.parse(e.data);
      if(msg.type==='output'){
        appendStreamOutput(msg.data);
      }else if(msg.type==='result'){
        // For WinRM sessions, re-enable input
        if(!isLocalSession){
          document.getElementById('btnCancel').style.display='none';
          document.getElementById('cmdInput').disabled=false;
          document.getElementById('btnSend').disabled=false;
        }
        refreshSessions();
      }else if(msg.type==='interrupted'){
        if(term)term.writeln('\x1b[33m[Interrupted]\x1b[0m');
        if(!isLocalSession){
          document.getElementById('btnCancel').style.display='none';
          document.getElementById('cmdInput').disabled=false;
          document.getElementById('btnSend').disabled=false;
        }
      }else if(msg.type==='error'){
        if(term)term.writeln('\x1b[31m[Error: '+msg.message+']\x1b[0m');
      }
    }catch(err){console.error('WS parse error:',err)}
  };
  ws.onclose=()=>{console.log('WebSocket disconnected')};
  ws.onerror=(e)=>{console.error('WebSocket error:',e)};
}

function appendStreamOutput(text){
  if(term){
    term.write(text);
  }
}

async function execCmd(){
  const input=document.getElementById('cmdInput'),cmd=input.value.trim();
  if(!cmd||!activeSession)return;
  input.value='';cmdHistory.unshift(cmd);cmdHistoryIdx=-1;

  // Get timeout from selector (0 = no timeout)
  const timeoutVal = parseInt(document.getElementById('timeoutSelect').value) || 600000;
  const timeout = timeoutVal === 0 ? 600000 : timeoutVal; // 0 means 10 min max

  // Show command in xterm for WinRM sessions
  if(term){
    term.writeln('\x1b[33m‚ùØ '+cmd+'\x1b[0m');
  }

  // Use WebSocket if connected
  if(ws && ws.readyState===WebSocket.OPEN){
    // For WinRM, use exec with timeout
    document.getElementById('btnCancel').style.display='';
    document.getElementById('cmdInput').disabled=true;
    document.getElementById('btnSend').disabled=true;
    ws.send(JSON.stringify({type:'exec',command:cmd,timeout}));
  }else{
    // Fallback to REST API (WinRM only)
    document.getElementById('btnCancel').style.display='';
    document.getElementById('cmdInput').disabled=true;
    document.getElementById('btnSend').disabled=true;
    try{
      const d=await api(`/session/${activeSession}/exec`,{method:'POST',body:{command:cmd,timeout}});
      if(term){
        const output=d.success?(d.output||'(no output)'):('\x1b[31m'+d.error+'\x1b[0m');
        term.write(output);
        if(!output.endsWith('\n'))term.writeln('');
      }
    }catch(err){
      if(term)term.writeln('\x1b[31mError: '+err.message+'\x1b[0m');
    }
    document.getElementById('btnCancel').style.display='none';
    document.getElementById('cmdInput').disabled=false;
    document.getElementById('btnSend').disabled=false;
    refreshSessions();
  }
}

async function cancelCmd(){
  if(!activeSession)return;
  // Use WebSocket if connected
  if(ws && ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'interrupt'}));
  }else{
    try{
      await api(`/session/${activeSession}/cancel`,{method:'POST'});
    }catch(err){console.log('Cancel failed:',err)}
  }
  document.getElementById('btnCancel').style.display='none';
}

async function broadcastCmd(){
  const cmd=prompt('Broadcast to ALL sessions:');
  if(!cmd||!sessions.length)return;
  if(term){
    term.writeln('\x1b[35m[BROADCAST] '+cmd+'\x1b[0m');
  }
  const d=await api('/sessions/exec-all',{method:'POST',body:{command:cmd}});
  if(term){
    for(const r of(d.results||[])){
      const s=sessions.find(x=>x.sessionId===r.sessionId);
      const label=s?s.label:r.sessionId;
      if(r.success){
        term.writeln('\x1b[36m['+label+']\x1b[0m');
        term.write(r.output||'(no output)');
        if(!(r.output||'').endsWith('\n'))term.writeln('');
      }else{
        term.writeln('\x1b[31m['+label+'] Error: '+r.error+'\x1b[0m');
      }
    }
  }
  refreshSessions();
}

async function closeSession(){
  if(!activeSession||!confirm('Close session?'))return;
  await closeSessionById(activeSession);
}

async function closeSessionById(id){
  await api(`/session/${id}`,{method:'DELETE'});
  delete hist[id];
  if(activeSession===id){
    activeSession=null;
    isLocalSession=false;
    if(ws){ws.close();ws=null;}
    document.getElementById('terminalTitle').textContent='Select or create a session';
    document.getElementById('btnClose').style.display='none';
    document.getElementById('btnCancel').style.display='none';
    document.getElementById('inputArea').style.display='';
    document.getElementById('cmdInput').disabled=true;
    document.getElementById('btnSend').disabled=true;
    hideXterm();
  }
  await refreshSessions();
  // Auto-select another session if available
  if(!activeSession&&sessions.length) selectSession(sessions[0].sessionId);
}

function showNewSession(){closeDrawer();document.getElementById('modal').classList.add('show')}
function hideModal(){document.getElementById('modal').classList.remove('show')}

async function createSession(){
  const computer=document.getElementById('modalComputer').value.trim()||'localhost';
  const label=document.getElementById('modalLabel').value.trim();
  const user=document.getElementById('modalUser').value.trim();
  const pass=document.getElementById('modalPass').value;
  const body={computer};if(label)body.label=label;
  if(user&&pass)body.credentials={username:user,password:pass};
  const d=await api('/session/create',{method:'POST',body});
  hideModal();
  if(d.success){await refreshSessions();selectSession(d.sessionId)}
  else{alert('Failed: '+d.error)}
  document.getElementById('modalLabel').value='';
  document.getElementById('modalUser').value='';
  document.getElementById('modalPass').value='';
}

// Create local terminal
async function quickLocal(shell){
  const names={powershell:'PowerShell',cmd:'CMD',bash:'Git Bash'};
  const d=await api('/session/create',{method:'POST',body:{type:'local',shell,label:names[shell]||shell}});
  if(d.success){await refreshSessions();selectSession(d.sessionId)}
  else{alert('Failed: '+d.error)}
}

// Create remote WinRM session
async function quickConnect(computer){
  const names={'192.168.1.42':'Harold-PC','192.168.1.97':'Morpu-PC','192.168.1.162':'AI-PC','192.168.1.192':'Rock-PC'};
  const d=await api('/session/create',{method:'POST',body:{type:'winrm',computer,label:names[computer]||computer}});
  if(d.success){await refreshSessions();selectSession(d.sessionId)}
  else{alert('Failed: '+d.error)}
}

// Keyboard history (desktop)
document.getElementById('cmdInput').addEventListener('keydown',e=>{
  if(e.key==='ArrowUp'){e.preventDefault();if(cmdHistoryIdx<cmdHistory.length-1){cmdHistoryIdx++;e.target.value=cmdHistory[cmdHistoryIdx]}}
  if(e.key==='ArrowDown'){e.preventDefault();if(cmdHistoryIdx>0){cmdHistoryIdx--;e.target.value=cmdHistory[cmdHistoryIdx]}else{cmdHistoryIdx=-1;e.target.value=''}}
});

// Handle mobile keyboard resize
if(window.visualViewport){
  window.visualViewport.addEventListener('resize',()=>{
    document.body.style.height=window.visualViewport.height+'px';
  });
  window.visualViewport.addEventListener('scroll',()=>{
    document.body.style.height=window.visualViewport.height+'px';
  });
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function fmtUp(ms){const s=Math.floor(ms/1000);if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';return Math.floor(s/3600)+'h'}

function showHelp(){
  // Hide xterm and show welcome message area with help content
  hideXterm();
  const welcomeEl=document.getElementById('welcome-msg');
  welcomeEl.innerHTML=`
<div style="text-align:left;line-height:1.8;display:inline-block;max-width:450px">
<h3 style="color:var(--accent);margin:0 0 12px;font-family:var(--sans)">WinRM Bridge Help</h3>

<b style="color:var(--accent)">Keyboard Shortcuts</b>
<div style="margin:4px 0 12px;font-size:12px">
  <b>Enter</b> - Execute command<br>
  <b>‚Üë / ‚Üì</b> - Navigate command history<br>
  <b>Ctrl+C</b> - Send interrupt to terminal
</div>

<b style="color:var(--accent)">Buttons</b>
<div style="margin:4px 0 12px;font-size:12px">
  <b>‚ö° Local</b> - Quick connect to localhost<br>
  <b>‚èπ STOP</b> - Cancel running command (Ctrl+C)<br>
  <b>‚ö° ALL</b> - Broadcast to all sessions<br>
  <b>+ NEW</b> - Create session (local or remote)
</div>

<b style="color:var(--accent)">Session Types</b>
<div style="margin:4px 0 12px;font-size:12px">
  <b>Local (‚å®)</b> - Full interactive PTY terminal<br>
  Supports colors, cursor movement, interactive CLIs<br><br>
  <b>Remote (üåê)</b> - WinRM command execution<br>
  Enter commands in input box below terminal
</div>

<b style="color:var(--accent)">API</b>
<div style="margin:4px 0;font-size:12px">
  REST: <code>http://localhost:8775/sessions</code><br>
  WebSocket: <code>ws://localhost:8775?session=ID</code>
</div>
</div>`;
  welcomeEl.style.display='';
}

refreshSessions();setInterval(refreshSessions,10000);
</script>
</body>
</html>